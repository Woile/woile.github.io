<!DOCTYPE html>
<html prefix="" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>How to test Selenium scrapper with Python | Willy's blog</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../../assets/css/screen.css">
<link rel="stylesheet" type="text/css" href="../../assets/css/nav.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,400%7CInconsolata">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://woile.github.io/posts/how-to-test-selenium-scrapper/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><script src="https://use.fontawesome.com/ac3419ca62.js"></script><meta name="author" content="Woile">
<link rel="prev" href="../guide-to-sublime-like-a-normal-person/" title="Guide to Sublime like a normal person" type="text/html">
<link rel="next" href="../decrypt-filesystem/" title="Decrypt filesystem" type="text/html">
<meta property="og:site_name" content="Willy's blog">
<meta property="og:title" content="How to test Selenium scrapper with Python">
<meta property="og:url" content="https://woile.github.io/posts/how-to-test-selenium-scrapper/">
<meta property="og:description" content="This week I've been writing tests for a project which is
using Selenium as a scrapper.
As you may know, Selenium is a testing framework, it's intended to be used while writing tests,
not as a web craw">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-09-12T11:38:40-03:00">
<meta property="article:tag" content="selenium python testing">
</head>
<body class="nav-closed">

<div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
<li class="nav-opened" role="presentation">
                <a href="../../">Home</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../stories/visited-places/">Around the world</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../categories/">Tags</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../rss.xml">RSS feed</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../archive.html">Archive</a>
            </li>
            

            <li class="nav-opened" role="presentation">
                <a href="javascript:void(0)" class="nested-url" data-children="nested-gallery">
                Gallery
                </a>
            </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/roca_de_la_sierra/" class="child">
                    Roca de la Sierra
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/portugal/castelo_de_campo_maior/" class="child">
                    Castelo de Campo Maior
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/portugal/porto/" class="child">
                    Porto
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/portugal/cascais/" class="child">
                    Cascais
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/portugal/quinta_de_regaleira/" class="child">
                    Quinta de Regaleira
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/seville/" class="child">
                    Sevilla
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/malaga/" class="child">
                    Malaga
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/nerja/" class="child">
                    Nerja
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/alhambra_granada/" class="child">
                    Alhambra y Generalife
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/valencia/" class="child">
                    Valencia
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/barcelona/sagrada_familia/" class="child">
                    Sagrada Familia
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/barcelona/camp_nou/" class="child">
                    Camp Nou
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/barcelona/cosmocaixa/" class="child">
                    Cosmocaixa
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/barcelona/park_guell/" class="child">
                    Park Güell
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/barcelona/ciudad_gotica_rambla/" class="child">
                    Barrio Gótico
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/barcelona/playa_badalona/" class="child">
                    Playa Badalona
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/santander/" class="child">
                    Santander
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/santillana/" class="child">
                    Santillana
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/madrid/" class="child">
                    Madrid
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/france/paris/" class="child">
                    Paris
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/belgium/brussels/" class="child">
                    Bruselas
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/belgium/brugge/" class="child">
                    Brujas
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/netherlands/rotterdam/" class="child">
                    Rotterdam
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/netherlands/amsterdam/" class="child">
                    Amsterdam
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/germany/hamburg/" class="child">
                    Hamburgo
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/germany/berlin/" class="child">
                    Berlin
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/poland/cracow/" class="child">
                    Cracovia
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/czech/prague/" class="child">
                    Praga
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/hungary/budapest/" class="child">
                    Budapest
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/greece/glyfada/" class="child">
                    Glyfada
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/italy/marina_del_cantone/" class="child">
                    Marina Del Cantone
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/italy/capri/" class="child">
                    Capri
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/italy/rome/" class="child">
                    Roma
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/italy/fermo/" class="child">
                    Fermo
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/italy/milano/" class="child">
                    Milan
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/italy/como/" class="child">
                    Como
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/england/cheltenham/" class="child">
                    Cheltenham
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/england/london/" class="child">
                    London
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/spain/palma_majorca/" class="child">
                    Palma de Mallorca
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/denmark/copenhaguen/" class="child">
                    Copenhaguen
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/brasil/sao_paulo/" class="child">
                    Sao Paulo
                    </a>
                </li>
                <li class="nav-opened nested-gallery hidden" role="presentation">
                    <a href="../../galleries/brasil/rio_de_janeiro/" class="child">
                    Rio de Janeiro
                    </a>
                </li>
            <li class="nav-opened" role="presentation">
                <a href="../../stories/who-am-i/">About me</a>
            </li>
    
    
    </ul>
</div>
<span class="nav-cover"></span>

<div class="site-wrapper">
    <header class="main-header post-head no-cover"><nav class="main-nav overlay clearfix"><a class="blog-logo" href="https://woile.github.io/"><img src="https://s.gravatar.com/avatar/7ff595c207c9b935811a691d2f3d2551?s=150" alt="Blog Logo"></a>
            <a class="menu-button" href="#"><span class="burger">☰</span><span class="word">Menu</span></a>
        </nav></header><main id="content" class="content" role="main"><article class="post post"><header class="post-header"><h1 class="post-title">How to test Selenium scrapper with Python</h1>
        <section class="post-meta"> by
            Woile
            on
                <a href="../../categories/selenium-python-testing/">#selenium python testing</a>,
            <time class="post-date" datetime="2017-09-12T11:38:40-03:00">
                2017-09-12 11:38
            </time></section></header><section class="post-content"><div>
<p>This week I've been writing tests for <a class="reference external" href="https://github.com/discov-r/pyinstamation">a project</a> which is
using Selenium as a scrapper.</p>
<p>As you may know, Selenium is a testing framework, it's intended to be used while writing tests,
not as a web crawler/scrapper.</p>
<p>But you can. Why? Because it runs a browser, and the browser is the real sh*t, so the Javascript
gets executed, and we are happy. There are other solutions like <a class="reference external" href="https://github.com/makinacorpus/spynner">Spynner</a>
or writing the scrapper in pure Javascript, but I felt comfortable using Selenium this way.</p>
<div class="section" id="the-problem">
<h2>The problem</h2>
<p>How do we <strong>test</strong> this scrapper? I want it to have tests, damn!</p>
</div>
<div class="section" id="solution">
<h2>Solution</h2>
<p>Save the static content while running the scrapper, then, serve it with a very small http server
while testing. Yes, it's a bit tedious, but it delivers.</p>
<!-- TEASER_END -->
<p>When should you save?</p>
<p>Whenever you need to. This is a good example:</p>
<pre class="code python"><a name="rest_code_466983f03d4a420b8ee70f157b6a47ac-1"></a><span class="n">url</span> <span class="o">=</span> <span class="s1">'https://betterexplained.com/articles/why-do-we-multiply-combinations/'</span>
<a name="rest_code_466983f03d4a420b8ee70f157b6a47ac-2"></a><span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">()</span>
<a name="rest_code_466983f03d4a420b8ee70f157b6a47ac-3"></a><span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a name="rest_code_466983f03d4a420b8ee70f157b6a47ac-4"></a><span class="n">save_current_state</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">current_url</span><span class="p">,</span> <span class="n">driver</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>
</pre>
<p>Can I see the code of <code>save_current_state</code>? Here you go:</p>
<pre class="code python"><a name="rest_code_b01dce5c30384aa69fddb722d862b032-1"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-2"></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-3"></a>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-4"></a><span class="n">SAVE_SOURCE</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># disable in production</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-5"></a><span class="n">TEST_LOCATION</span> <span class="o">=</span> <span class="s1">'tests/static'</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-6"></a>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-7"></a>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-8"></a><span class="k">def</span> <span class="nf">save_current_state</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-9"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">SAVE_SOURCE</span><span class="p">:</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-10"></a>        <span class="k">return</span> <span class="bp">None</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-11"></a>    <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-12"></a>        <span class="n">location</span> <span class="o">=</span> <span class="n">TEST_LOCATION</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-13"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-14"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'source must be a string'</span><span class="p">)</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-15"></a>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-16"></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'/'</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.html'</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-17"></a>    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-18"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-19"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-20"></a>
<a name="rest_code_b01dce5c30384aa69fddb722d862b032-21"></a>    <span class="k">return</span> <span class="n">filepath</span>
</pre>
<p>Notice how the url is used as the file name (safely parsed). This helps a lot to match urls.
But of course, a case where something custom is required may happen, so you can tune the server to
fit any case.</p>
<p>And the python server? A minor modification from <a class="reference external" href="https://realpython.com/blog/python/testing-third-party-apis-with-mock-servers/">here</a></p>
<pre class="code python"><a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-1"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-2"></a><span class="kn">import</span> <span class="nn">socket</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-3"></a><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-4"></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-5"></a><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-6"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-7"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-8"></a><span class="n">TEST_LOCATION</span> <span class="o">=</span> <span class="s1">'tests/static'</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-9"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-10"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-11"></a><span class="k">class</span> <span class="nc">MockServerRequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-12"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-13"></a>    <span class="k">def</span> <span class="nf">_set_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Set-Cookie'</span><span class="p">,</span> <span class="s1">'exampleid=c295IGVsIHVzdWFyaW8gZW5pdG8K'</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Content-type'</span><span class="p">,</span> <span class="s1">'text/html'</span><span class="p">)</span>  <span class="c1"># change at will</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-18"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-19"></a>    <span class="nd">@property</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-20"></a>    <span class="k">def</span> <span class="nf">_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-21"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'/'</span><span class="p">),</span> <span class="n">safe</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-22"></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_LOCATION</span><span class="p">,</span> <span class="s1">'{0}.html'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-23"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-24"></a>    <span class="k">def</span> <span class="nf">_read_from_file_or_404</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-25"></a>        <span class="k">try</span><span class="p">:</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-26"></a>            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-27"></a>        <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">&lt;html&gt;&lt;body&gt;404 Not Found!&lt;/body&gt;&lt;/html&gt;'</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-30"></a>        <span class="k">else</span><span class="p">:</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-32"></a>            <span class="c1"># needs an extra new line</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-34"></a>            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-35"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-36"></a>    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_headers</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file_or_404</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-39"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-40"></a>    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_headers</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file_or_404</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-43"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-44"></a>    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-45"></a>        <span class="sd">"""Do not write log messages to std. Disable to see the requests."""</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-46"></a>        <span class="k">return</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-47"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-48"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-49"></a><span class="k">def</span> <span class="nf">get_free_port</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-50"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-51"></a>    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-52"></a>    <span class="n">address</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-53"></a>    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-54"></a>    <span class="k">return</span> <span class="n">port</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-55"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-56"></a>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-57"></a><span class="k">def</span> <span class="nf">start_mock_server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-58"></a>    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-59"></a>        <span class="n">port</span> <span class="o">=</span> <span class="n">get_free_port</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-60"></a>    <span class="n">mock_server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">MockServerRequestHandler</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-61"></a>    <span class="n">mock_server_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mock_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-62"></a>    <span class="n">mock_server_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-63"></a>    <span class="n">mock_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a name="rest_code_5f9dc30dc1f2476f8df353e416f799f3-64"></a>    <span class="k">return</span> <span class="s1">'{hostname}:{port}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</pre>
<p>And finally the base test from which you will inherit, whenever you need to test the scrapper.</p>
<pre class="code python"><a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-1"></a><span class="kn">import</span> <span class="nn">unittest</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-2"></a><span class="kn">from</span> <span class="nn">my_project</span> <span class="kn">import</span> <span class="n">const</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-3"></a><span class="kn">from</span> <span class="nn">tests</span> <span class="kn">import</span> <span class="n">start_mock_server</span>  <span class="c1"># or where you saved it</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-4"></a>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-5"></a>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-6"></a><span class="k">class</span> <span class="nc">BaseScrapperTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-7"></a>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-8"></a>    <span class="nd">@classmethod</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-9"></a>    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-10"></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">start_mock_server</span><span class="p">()</span>
<a name="rest_code_339800490c8f44b686fbb0e3ad1eaf11-11"></a>        <span class="n">const</span><span class="o">.</span><span class="n">HOSTNAME</span> <span class="o">=</span> <span class="n">url</span>
</pre>
<p>Take a look at that last line, your project must have a central point where the <strong>HOSTNAME</strong> is set.
Before testing, you need to tell to your application to hit your localserver.</p>
</div>
<div class="section" id="final-notes">
<h2>Final notes</h2>
<p>If you find hard to test some scrapper function, try dividing it into smaller functions, and testing
them individually.</p>
<p>If a scrapper function does not include any condition, it's okay to <code>return True</code> at the end,
and assert that boolean. If something goes wrong in the scrapper, we'll get noticied with an exception
and the test will throw an error. Also, if you wanted to <a class="reference external" href="https://stackoverflow.com/a/4319870/2047185">receive a fail</a>
instead of an error, which is more pythonic, you should do something like this in your test:</p>
<pre class="code python"><a name="rest_code_329e759e6a4246b6a0e7295c59e75bd7-1"></a><span class="k">try</span><span class="p">:</span>
<a name="rest_code_329e759e6a4246b6a0e7295c59e75bd7-2"></a>    <span class="n">users_from_github</span><span class="p">()</span>
<a name="rest_code_329e759e6a4246b6a0e7295c59e75bd7-3"></a><span class="k">except</span> <span class="n">ExceptionType</span><span class="p">:</span>
<a name="rest_code_329e759e6a4246b6a0e7295c59e75bd7-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">"users_from_github() raised ExceptionType unexpectedly!"</span><span class="p">)</span>
</pre>
<p>Try isolating the scrapper as much as possible from the rest of your project, whenever you need
to use selenium, avoid including bussiness logic in it as well, this difficults testing and makes
the code quite confusing.</p>
<p>Regards!</p>
</div>
</div>
    </section><footer class="post-footer"><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="woile",
            disqus_url="https://woile.github.io/posts/how-to-test-selenium-scrapper/",
        disqus_title="How to test Selenium scrapper with Python",
        disqus_identifier="cache/posts/how-to-test-selenium-scrapper.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></footer></article><script>var disqus_shortname="woile";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script></main><footer class="site-footer clearfix"><section class="poweredby">Contents © 2019         <a href="mailto:santiwilly@gmail.com">Woile</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </section></footer>
</div>

    <script type="text/javascript" src="../../assets/js/jquery.js"></script><script type="text/javascript" src="../../assets/js/jquery.fitvids.js"></script><script type="text/javascript" src="../../assets/js/index.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77945905-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
