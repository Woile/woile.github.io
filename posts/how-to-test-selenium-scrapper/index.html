<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>How to test Selenium scrapper with Python | Willy's blog</title>
<link href="../../assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://woile.github.io/posts/how-to-test-selenium-scrapper/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><script src="https://use.fontawesome.com/ac3419ca62.js"></script><meta name="author" content="Woile">
<link rel="prev" href="../guide-to-sublime-like-a-normal-person/" title="Guide to Sublime like a normal person" type="text/html">
<link rel="next" href="../decrypt-filesystem/" title="Decrypt filesystem" type="text/html">
<meta property="og:site_name" content="Willy's blog">
<meta property="og:title" content="How to test Selenium scrapper with Python">
<meta property="og:url" content="https://woile.github.io/posts/how-to-test-selenium-scrapper/">
<meta property="og:description" content="This week I've been writing tests for a project which is
using Selenium as a scrapper.
As you may know, Selenium is a testing framework, it's intended to be used while writing tests,
not as a web craw">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-09-12T11:38:40-03:00">
<meta property="article:tag" content="selenium python testing">
</head>
<body class="theme-base-0b">
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
            styles, `#sidebar-checkbox` for behavior. -->
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><!-- Toggleable sidebar --><div class="sidebar" id="sidebar">
        <div class="sidebar-item">
            <p>My Personal blog.</p>
        </div>
        
    <nav id="menu" role="navigation" class="sidebar-nav"><a class="sidebar-nav-item" href="../../galleries/spain/roca_de_la_sierra/">Roca de la Sierra</a>
        <a class="sidebar-nav-item" href="../../galleries/portugal/castelo_de_campo_maior/">Castelo de Campo Maior</a>
        <a class="sidebar-nav-item" href="../../galleries/portugal/porto/">Porto</a>
        <a class="sidebar-nav-item" href="../../galleries/portugal/cascais/">Cascais</a>
        <a class="sidebar-nav-item" href="../../galleries/portugal/quinta_de_regaleira/">Quinta de Regaleira</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/seville/">Sevilla</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/malaga/">Malaga</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/nerja/">Nerja</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/alhambra_granada/">Alhambra y Generalife</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/valencia/">Valencia</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/barcelona/sagrada_familia/">Sagrada Familia</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/barcelona/camp_nou/">Camp Nou</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/barcelona/cosmocaixa/">Cosmocaixa</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/barcelona/park_guell/">Park Güell</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/barcelona/ciudad_gotica_rambla/">Barrio Gótico</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/barcelona/playa_badalona/">Playa Badalona</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/santander/">Santander</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/santillana/">Santillana</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/madrid/">Madrid</a>
        <a class="sidebar-nav-item" href="../../galleries/france/paris/">Paris</a>
        <a class="sidebar-nav-item" href="../../galleries/belgium/brussels/">Bruselas</a>
        <a class="sidebar-nav-item" href="../../galleries/belgium/brugge/">Brujas</a>
        <a class="sidebar-nav-item" href="../../galleries/netherlands/rotterdam/">Rotterdam</a>
        <a class="sidebar-nav-item" href="../../galleries/netherlands/amsterdam/">Amsterdam</a>
        <a class="sidebar-nav-item" href="../../galleries/germany/hamburg/">Hamburgo</a>
        <a class="sidebar-nav-item" href="../../galleries/germany/berlin/">Berlin</a>
        <a class="sidebar-nav-item" href="../../galleries/poland/cracow/">Cracovia</a>
        <a class="sidebar-nav-item" href="../../galleries/czech/prague/">Praga</a>
        <a class="sidebar-nav-item" href="../../galleries/hungary/budapest/">Budapest</a>
        <a class="sidebar-nav-item" href="../../galleries/greece/glyfada/">Glyfada</a>
        <a class="sidebar-nav-item" href="../../galleries/italy/marina_del_cantone/">Marina Del Cantone</a>
        <a class="sidebar-nav-item" href="../../galleries/italy/capri/">Capri</a>
        <a class="sidebar-nav-item" href="../../galleries/italy/rome/">Roma</a>
        <a class="sidebar-nav-item" href="../../galleries/italy/fermo/">Fermo</a>
        <a class="sidebar-nav-item" href="../../galleries/italy/milano/">Milan</a>
        <a class="sidebar-nav-item" href="../../galleries/italy/como/">Como</a>
        <a class="sidebar-nav-item" href="../../galleries/england/cheltenham/">Cheltenham</a>
        <a class="sidebar-nav-item" href="../../galleries/england/london/">London</a>
        <a class="sidebar-nav-item" href="../../galleries/spain/palma_majorca/">Palma de Mallorca</a>
        <a class="sidebar-nav-item" href="../../galleries/denmark/copenhaguen/">Copenhaguen</a>
        <a class="sidebar-nav-item" href="../../galleries/brasil/sao_paulo/">Sao Paulo</a>
        <a class="sidebar-nav-item" href="../../galleries/brasil/rio_de_janeiro/">Rio de Janeiro</a>
        <a class="sidebar-nav-item" href="../../archive.html">Archive</a>
        <a class="sidebar-nav-item" href="../../categories/">Tags</a>
        <a class="sidebar-nav-item" href="../../rss.xml">RSS feed</a>
        <a class="sidebar-nav-item" href="../../stories/visited-places/">Map</a>
        <a class="sidebar-nav-item" href="../../stories/who-am-i/">About me</a>
    
    
    </nav>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          
    <h3 id="brand" class="masthead-title">
      <a href="https://woile.github.io/" title="Willy's blog" rel="home">Willy's blog</a>

      <div class="pull-right">

            <a rel="noopener noreferrer" target="_blank" href="https://twitter.com/santiwilly" title="Twitter">
                <i class="fa fa-twitter fa-fw" aria-hidden="true"></i>
            </a>
            <a rel="noopener noreferrer" target="_blank" href="https://github.com/Woile" title="Github">
                <i class="fa fa-github fa-fw" aria-hidden="true"></i>
            </a>
            <a rel="noopener noreferrer" target="_blank" href="https://www.linkedin.com/in/santiago-fraire-63b91226" title="Linkedin">
                <i class="fa fa-linkedin fa-fw" aria-hidden="true"></i>
            </a>
      </div>

    </h3>

        </div>
      </div>

      <div class="container content" id="content">
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="post-title p-name entry-title" itemprop="headline name"><a href="." class="u-url">How to test Selenium scrapper with Python</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Woile</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="post-date published dt-published" datetime="2017-09-12T11:38:40-03:00" itemprop="datePublished" title="2017-09-12 11:38">2017-09-12 11:38</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/how-to-test-selenium-scrapper.html">Comments</a>


        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>This week I've been writing tests for <a class="reference external" href="https://github.com/discov-r/pyinstamation">a project</a> which is
using Selenium as a scrapper.</p>
<p>As you may know, Selenium is a testing framework, it's intended to be used while writing tests,
not as a web crawler/scrapper.</p>
<p>But you can. Why? Because it runs a browser, and the browser is the real sh*t, so the Javascript
gets executed, and we are happy. There are other solutions like <a class="reference external" href="https://github.com/makinacorpus/spynner">Spynner</a>
or writing the scrapper in pure Javascript, but I felt comfortable using Selenium this way.</p>
<div class="section" id="the-problem">
<h2>The problem</h2>
<p>How do we <strong>test</strong> this scrapper? I want it to have tests, damn!</p>
</div>
<div class="section" id="solution">
<h2>Solution</h2>
<p>Save the static content while running the scrapper, then, serve it with a very small http server
while testing. Yes, it's a bit tedious, but it delivers.</p>
<p>When should you save?</p>
<p>Whenever you need to. This is a good example:</p>
<pre class="code python"><a name="rest_code_86c453193c1f401984ea8d2c05bbfc95-1"></a><span class="n">url</span> <span class="o">=</span> <span class="s1">'https://betterexplained.com/articles/why-do-we-multiply-combinations/'</span>
<a name="rest_code_86c453193c1f401984ea8d2c05bbfc95-2"></a><span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">()</span>
<a name="rest_code_86c453193c1f401984ea8d2c05bbfc95-3"></a><span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a name="rest_code_86c453193c1f401984ea8d2c05bbfc95-4"></a><span class="n">save_current_state</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">current_url</span><span class="p">,</span> <span class="n">driver</span><span class="o">.</span><span class="n">page_source</span><span class="p">)</span>
</pre>
<p>Can I see the code of <code>save_current_state</code>? Here you go:</p>
<pre class="code python"><a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-1"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-2"></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-3"></a>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-4"></a><span class="n">SAVE_SOURCE</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># disable in production</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-5"></a><span class="n">TEST_LOCATION</span> <span class="o">=</span> <span class="s1">'tests/static'</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-6"></a>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-7"></a>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-8"></a><span class="k">def</span> <span class="nf">save_current_state</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-9"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">SAVE_SOURCE</span><span class="p">:</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-10"></a>        <span class="k">return</span> <span class="bp">None</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-11"></a>    <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-12"></a>        <span class="n">location</span> <span class="o">=</span> <span class="n">TEST_LOCATION</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-13"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-14"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'source must be a string'</span><span class="p">)</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-15"></a>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-16"></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">'/'</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.html'</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-17"></a>    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-18"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-19"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-20"></a>
<a name="rest_code_1b1ee5191763424b88c2eaa6fea3f05c-21"></a>    <span class="k">return</span> <span class="n">filepath</span>
</pre>
<p>Notice how the url is used as the file name (safely parsed). This helps a lot to match urls.
But of course, a case where something custom is required may happen, so you can tune the server to
fit any case.</p>
<p>And the python server? A minor modification from <a class="reference external" href="https://realpython.com/blog/python/testing-third-party-apis-with-mock-servers/">here</a></p>
<pre class="code python"><a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-1"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-2"></a><span class="kn">import</span> <span class="nn">socket</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-3"></a><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-4"></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-5"></a><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-6"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-7"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-8"></a><span class="n">TEST_LOCATION</span> <span class="o">=</span> <span class="s1">'tests/static'</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-9"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-10"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-11"></a><span class="k">class</span> <span class="nc">MockServerRequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-12"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-13"></a>    <span class="k">def</span> <span class="nf">_set_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Set-Cookie'</span><span class="p">,</span> <span class="s1">'exampleid=c295IGVsIHVzdWFyaW8gZW5pdG8K'</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Content-type'</span><span class="p">,</span> <span class="s1">'text/html'</span><span class="p">)</span>  <span class="c1"># change at will</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-18"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-19"></a>    <span class="nd">@property</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-20"></a>    <span class="k">def</span> <span class="nf">_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-21"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'/'</span><span class="p">),</span> <span class="n">safe</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-22"></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_LOCATION</span><span class="p">,</span> <span class="s1">'{0}.html'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-23"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-24"></a>    <span class="k">def</span> <span class="nf">_read_from_file_or_404</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-25"></a>        <span class="k">try</span><span class="p">:</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-26"></a>            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-27"></a>        <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">&lt;html&gt;&lt;body&gt;404 Not Found!&lt;/body&gt;&lt;/html&gt;'</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-30"></a>        <span class="k">else</span><span class="p">:</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-32"></a>            <span class="c1"># needs an extra new line</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-34"></a>            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-35"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-36"></a>    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_headers</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file_or_404</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-39"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-40"></a>    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_headers</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_file_or_404</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-43"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-44"></a>    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-45"></a>        <span class="sd">"""Do not write log messages to std. Disable to see the requests."""</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-46"></a>        <span class="k">return</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-47"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-48"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-49"></a><span class="k">def</span> <span class="nf">get_free_port</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-50"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-51"></a>    <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-52"></a>    <span class="n">address</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-53"></a>    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-54"></a>    <span class="k">return</span> <span class="n">port</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-55"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-56"></a>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-57"></a><span class="k">def</span> <span class="nf">start_mock_server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-58"></a>    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-59"></a>        <span class="n">port</span> <span class="o">=</span> <span class="n">get_free_port</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-60"></a>    <span class="n">mock_server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">MockServerRequestHandler</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-61"></a>    <span class="n">mock_server_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mock_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-62"></a>    <span class="n">mock_server_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-63"></a>    <span class="n">mock_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a name="rest_code_1b4acbcda9154d83abffa393d8e2a138-64"></a>    <span class="k">return</span> <span class="s1">'{hostname}:{port}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</pre>
<p>And finally the base test from which you will inherit, whenever you need to test the scrapper.</p>
<pre class="code python"><a name="rest_code_f707887c1737413292ff69ca18ce8b98-1"></a><span class="kn">import</span> <span class="nn">unittest</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-2"></a><span class="kn">from</span> <span class="nn">my_project</span> <span class="kn">import</span> <span class="n">const</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-3"></a><span class="kn">from</span> <span class="nn">tests</span> <span class="kn">import</span> <span class="n">start_mock_server</span>  <span class="c1"># or where you saved it</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-4"></a>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-5"></a>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-6"></a><span class="k">class</span> <span class="nc">BaseScrapperTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-7"></a>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-8"></a>    <span class="nd">@classmethod</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-9"></a>    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-10"></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">start_mock_server</span><span class="p">()</span>
<a name="rest_code_f707887c1737413292ff69ca18ce8b98-11"></a>        <span class="n">const</span><span class="o">.</span><span class="n">HOSTNAME</span> <span class="o">=</span> <span class="n">url</span>
</pre>
<p>Take a look at that last line, your project must have a central point where the <strong>HOSTNAME</strong> is set.
Before testing, you need to tell to your application to hit your localserver.</p>
</div>
<div class="section" id="final-notes">
<h2>Final notes</h2>
<p>If you find hard to test some scrapper function, try dividing it into smaller functions, and testing
them individually.</p>
<p>If a scrapper function does not include any condition, it's okay to <code>return True</code> at the end,
and assert that boolean. If something goes wrong in the scrapper, we'll get noticied with an exception
and the test will throw an error. Also, if you wanted to <a class="reference external" href="https://stackoverflow.com/a/4319870/2047185">receive a fail</a>
instead of an error, which is more pythonic, you should do something like this in your test:</p>
<pre class="code python"><a name="rest_code_69f5249ec9554c15a00ce94f93c7ae9e-1"></a><span class="k">try</span><span class="p">:</span>
<a name="rest_code_69f5249ec9554c15a00ce94f93c7ae9e-2"></a>    <span class="n">users_from_github</span><span class="p">()</span>
<a name="rest_code_69f5249ec9554c15a00ce94f93c7ae9e-3"></a><span class="k">except</span> <span class="n">ExceptionType</span><span class="p">:</span>
<a name="rest_code_69f5249ec9554c15a00ce94f93c7ae9e-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">"users_from_github() raised ExceptionType unexpectedly!"</span><span class="p">)</span>
</pre>
<p>Try isolating the scrapper as much as possible from the rest of your project, whenever you need
to use selenium, avoid including bussiness logic in it as well, this difficults testing and makes
the code quite confusing.</p>
<p>Regards!</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/selenium-python-testing/" rel="tag">selenium python testing</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../guide-to-sublime-like-a-normal-person/" rel="prev" title="Guide to Sublime like a normal person">Previous post</a>
            </li>
            <li class="next">
                <a href="../decrypt-filesystem/" rel="next" title="Decrypt filesystem">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="woile",
            disqus_url="https://woile.github.io/posts/how-to-test-selenium-scrapper/",
        disqus_title="How to test Selenium scrapper with Python",
        disqus_identifier="cache/posts/how-to-test-selenium-scrapper.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="woile";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2018         <a href="mailto:santiwilly@gmail.com">Woile</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </div>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77945905-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
